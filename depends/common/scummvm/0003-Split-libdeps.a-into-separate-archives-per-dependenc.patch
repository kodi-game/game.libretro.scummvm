From 74a514868cef8af87dc6c1a930c9531e521cfc7c Mon Sep 17 00:00:00 2001
From: Garrett Brown <themagnificentmrb@gmail.com>
Date: Thu, 18 Jul 2024 13:21:31 -0700
Subject: [PATCH 3/3] Split libdeps.a into separate archives per dependency

---
 backends/platform/libretro/Makefile        | 118 ++++++++++++++++++++-
 backends/platform/libretro/dependencies.mk |  36 +++----
 2 files changed, 132 insertions(+), 22 deletions(-)

diff --git a/backends/platform/libretro/Makefile b/backends/platform/libretro/Makefile
index bb3b8ca94f9..97c92cbfc88 100644
--- a/backends/platform/libretro/Makefile
+++ b/backends/platform/libretro/Makefile
@@ -596,20 +596,130 @@ $(TARGET): libnx-ln $(OBJS) libdeps.a libdetect.a
 	cp $+ libtemp/
 	$(AR) -M < $(ROOT_PATH)/script.mri
 else ifeq ($(STATIC_LINKING), 1)
-$(TARGET): $(OBJS) libdeps.a libdetect.a
+$(TARGET): libdeps.a $(OBJS) libdetect.a # TODO
 	$(MKDIR) libtemp
 	$(CP) $+ libtemp/
 	@echo Linking $@...
 	$(AR) -M < $(ROOT_PATH)/script.mri
 else
-$(TARGET): $(DETECT_OBJS) $(OBJS) libdeps.a
+$(TARGET): libdeps.a $(DETECT_OBJS) $(OBJS) # TODO
 	@echo Linking $@...
 	$(HIDE)$(LD) $(LDFLAGS) $+ $(LIBS) $(LINKOUT)$@
 endif
 
-libdeps.a: $(OBJS_DEPS)
+######################################################################
+# Dependencies
+######################################################################
+
+OBJS_DEPS = $(OBJS_DEPS_LIBRETRO_COMMON)
+libdeps_libretro_common.a: $(OBJS_DEPS_LIBRETRO_COMMON)
 	@echo Linking $@...
-	$(HIDE)$(AR) $@ $^
+	$(AR) rcs $@ $^
+LIBDEPS_SUBARCHIVES = libdeps_libretro_common.a
+
+ifeq ($(USE_FLUIDSYNTH), 1)
+OBJS_DEPS += $(OBJS_DEPS_FLUIDSYNTH)
+libdeps_fluidsynth.a: $(OBJS_DEPS_FLUIDSYNTH)
+	@echo Linking $@...
+	$(AR) rcs $@ $^
+LIBDEPS_SUBARCHIVES += libdeps_fluidsynth.a
+endif
+
+ifeq ($(USE_FLAC), 1)
+OBJS_DEPS += $(OBJS_DEPS_LIBFLAC)
+libdeps_libflac.a: $(OBJS_DEPS_LIBFLAC)
+	@echo Linking $@...
+	$(AR) rcs $@ $^
+LIBDEPS_SUBARCHIVES += libdeps_libflac.a
+endif
+
+ifeq ($(USE_VORBIS), 1)
+OBJS_DEPS += $(OBJS_DEPS_LIBVORBIS)
+libdeps_libvorbis.a: $(OBJS_DEPS_LIBVORBIS)
+	@echo Linking $@...
+	$(AR) rcs $@ $^
+LIBDEPS_SUBARCHIVES += libdeps_libvorbis.a
+endif
+
+ifeq ($(USE_TREMOR), 1)
+OBJS_DEPS += $(OBJS_DEPS_TREMOR)
+libdeps_tremor.a: $(OBJS_DEPS_TREMOR)
+	@echo Linking $@...
+	$(AR) rcs $@ $^
+LIBDEPS_SUBARCHIVES += libdeps_tremor.a
+endif
+
+ifeq ($(USE_ZLIB), 1)
+OBJS_DEPS += $(OBJS_DEPS_LIBZ)
+libdeps_libz.a: $(OBJS_DEPS_LIBZ)
+	@echo Linking $@...
+	$(AR) rcs $@ $^
+LIBDEPS_SUBARCHIVES += libdeps_libz.a
+endif
+
+ifeq ($(USE_MAD), 1)
+OBJS_DEPS += $(OBJS_DEPS_LIBMAD)
+libdeps_libmad.a: $(OBJS_DEPS_LIBMAD)
+	@echo Linking $@...
+	$(AR) rcs $@ $^
+LIBDEPS_SUBARCHIVES += libdeps_libmad.a
+endif
+
+ifeq ($(USE_FAAD), 1)
+OBJS_DEPS += $(OBJS_DEPS_FAAD)
+libdeps_faad.a: $(OBJS_DEPS_FAAD)
+	@echo Linking $@...
+	$(AR) rcs $@ $^
+LIBDEPS_SUBARCHIVES += libdeps_faad.a
+endif
+
+ifeq ($(USE_PNG), 1)
+OBJS_DEPS += $(OBJS_DEPS_PNG)
+libdeps_png.a: $(OBJS_DEPS_PNG)
+	@echo Linking $@...
+	$(AR) rcs $@ $^
+LIBDEPS_SUBARCHIVES += libdeps_png.a
+endif
+
+ifeq ($(USE_JPEG), 1)
+OBJS_DEPS += $(OBJS_DEPS_JPEG)
+libdeps_jpeg.a: $(OBJS_DEPS_JPEG)
+	@echo Linking $@...
+	$(AR) rcs $@ $^
+LIBDEPS_SUBARCHIVES += libdeps_jpeg.a
+endif
+
+ifeq ($(USE_THEORADEC), 1)
+OBJS_DEPS += $(OBJS_DEPS_THEORA)
+libdeps_theora.a: $(OBJS_DEPS_THEORA)
+	@echo Linking $@...
+	$(AR) rcs $@ $^
+LIBDEPS_SUBARCHIVES += libdeps_theora.a
+endif
+
+ifeq ($(USE_FREETYPE2), 1)
+OBJS_DEPS += $(OBJS_DEPS_FREETYPE)
+libdeps_freetype.a: $(OBJS_DEPS_FREETYPE)
+	@echo Linking $@...
+	$(AR) rcs $@ $^
+LIBDEPS_SUBARCHIVES += libdeps_freetype.a
+endif
+
+ifeq ($(USE_FRIBIDI), 1)
+OBJS_DEPS += $(OBJS_DEPS_FRIBIDI)
+libdeps_fribidi.a: $(OBJS_DEPS_FRIBIDI)
+	@echo Linking $@...
+	$(AR) rcs $@ $^
+LIBDEPS_SUBARCHIVES += libdeps_fribidi.a
+endif
+
+libdeps.a: $(LIBDEPS_SUBARCHIVES)
+	@echo Linking $@...
+	$(AR) rcs $@ $^
+
+######################################################################
+# End of dependencies
+######################################################################
 
 libdetect.a: $(DETECT_OBJS)
 	@echo Linking $@...
diff --git a/backends/platform/libretro/dependencies.mk b/backends/platform/libretro/dependencies.mk
index 3435eda00c7..039bb78e690 100644
--- a/backends/platform/libretro/dependencies.mk
+++ b/backends/platform/libretro/dependencies.mk
@@ -37,7 +37,7 @@ sharedlibs_system_lib_message = $(info - Use system shared $(shell printf ' $(th
 
 INCLUDES  += -I$(DEPS_PATH)/$(DEPS_FOLDER_libretro-common)/include \
 	-I$(DEPS_PATH)/$(DEPS_FOLDER_libretro-common)/include/compat
-OBJS_DEPS += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-common)/file/file_path_io.o \
+OBJS_DEPS_LIBRETRO_COMMON += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-common)/file/file_path_io.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-common)/file/file_path.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-common)/file/retro_dirent.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-common)/vfs/vfs_implementation.o \
@@ -48,16 +48,16 @@ OBJS_DEPS += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-common)/file/file_path_io.o \
 
 
 ifeq ($(USE_LIBCO), 1)
-OBJS_DEPS += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-common)/libco/libco.o
+OBJS_DEPS_LIBRETRO_COMMON += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-common)/libco/libco.o
 ifeq ($(platform), genode)
-OBJS_DEPS += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-common)/libco/genode.o
+OBJS_DEPS_LIBRETRO_COMMON += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-common)/libco/genode.o
 endif
 else
-OBJS_DEPS += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-common)/rthreads/rthreads.o
+OBJS_DEPS_LIBRETRO_COMMON += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-common)/rthreads/rthreads.o
 endif
 
 ifneq ($(STATIC_LINKING), 1)
-OBJS_DEPS += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-common)/encodings/encoding_utf.o \
+OBJS_DEPS_LIBRETRO_COMMON += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-common)/encodings/encoding_utf.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-common)/compat/fopen_utf8.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-common)/compat/compat_strl.o
 endif
@@ -78,7 +78,7 @@ INCLUDES += -I$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/fluidlite/include \
 	-I$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/fluidlite/src \
 	-I$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libvorbis/include \
 	-I$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libogg/include
-OBJS_DEPS += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/fluidlite/src/fluid_chan.o \
+OBJS_DEPS_FLUIDSYNTH += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/fluidlite/src/fluid_chan.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/fluidlite/src/fluid_chorus.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/fluidlite/src/fluid_conv.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/fluidlite/src/fluid_defsfont.o \
@@ -110,7 +110,7 @@ this_lib_flags := -lFLAC
 include $(ROOT_PATH)/sharedlib_test.mk
 ifneq ($(this_lib_available), yes)
 INCLUDES += -I$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libFLAC/include
-OBJS_DEPS += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libFLAC/bitreader.o \
+OBJS_DEPS_LIBFLAC += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libFLAC/bitreader.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libFLAC/cpu.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libFLAC/crc.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libFLAC/fixed.o \
@@ -122,7 +122,7 @@ OBJS_DEPS += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libFLAC/bitreader.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libFLAC/stream_decoder.o
 
 ifeq ($(platform), win)
-OBJS_DEPS += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libFLAC/share/win_utf8_io/win_utf8_io.o \
+OBJS_DEPS_LIBFLAC += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libFLAC/share/win_utf8_io/win_utf8_io.o \
 	 $(SCUMMVM_PATH)/backends/platform/sdl/win32/win32_wrapper.o
 endif
 endif
@@ -142,7 +142,7 @@ ifneq ($(this_lib_available), yes)
 INCLUDES += -I$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libogg/include \
 	-I$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libvorbis/include \
 	-I$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libvorbis/lib
-OBJS_DEPS += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libogg/src/bitwise.o \
+OBJS_DEPS_LIBVORBIS += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libogg/src/bitwise.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libogg/src/framing.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libvorbis/lib/analysis.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libvorbis/lib/bitrate.o \
@@ -181,7 +181,7 @@ this_lib_flags := -ltremor
 include $(ROOT_PATH)/sharedlib_test.mk
 ifneq ($(this_lib_available), yes)
 INCLUDES  += -I$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)
-OBJS_DEPS += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/tremor/bitwise.o \
+OBJS_DEPS_TREMOR += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/tremor/bitwise.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/tremor/block.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/tremor/codebook.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/tremor/floor0.o \
@@ -210,7 +210,7 @@ this_lib_header := zlib.h
 this_lib_flags := -lz
 include $(ROOT_PATH)/sharedlib_test.mk
 ifneq ($(this_lib_available), yes)
-OBJS_DEPS += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libz/deflate.o \
+OBJS_DEPS_LIBZ += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libz/deflate.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libz/gzlib.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libz/uncompr.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libz/zutil.o \
@@ -240,7 +240,7 @@ this_lib_flags := -lmad
 include $(ROOT_PATH)/sharedlib_test.mk
 ifneq ($(this_lib_available), yes)
 INCLUDES += -I$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libmad
-OBJS_DEPS += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libmad/bit.o \
+OBJS_DEPS_LIBMAD += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libmad/bit.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libmad/decoder.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libmad/frame.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libmad/huffman.o \
@@ -264,7 +264,7 @@ this_lib_flags := -lfaad
 include $(ROOT_PATH)/sharedlib_test.mk
 ifneq ($(this_lib_available), yes)
 INCLUDES += -I$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libfaad/include -I$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libfaad/libfaad
-OBJS_DEPS += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libfaad/libfaad/bits.o \
+OBJS_DEPS_FAAD += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libfaad/libfaad/bits.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libfaad/libfaad/cfft.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libfaad/libfaad/common.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libfaad/libfaad/decoder.o \
@@ -313,7 +313,7 @@ this_lib_flags := -lpng
 include $(ROOT_PATH)/sharedlib_test.mk
 ifneq ($(this_lib_available), yes)
 INCLUDES += -I$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libpng
-OBJS_DEPS += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libpng/png.o \
+OBJS_DEPS_PNG += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libpng/png.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libpng/pngerror.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libpng/pngget.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libpng/pngmem.o \
@@ -343,7 +343,7 @@ this_lib_flags := -ljpeg
 include $(ROOT_PATH)/sharedlib_test.mk
 ifneq ($(this_lib_available), yes)
 INCLUDES += -I$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libjpeg
-OBJS_DEPS += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libjpeg/jaricom.o \
+OBJS_DEPS_JPEG += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libjpeg/jaricom.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libjpeg/jcapimin.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libjpeg/jcapistd.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/libjpeg/jcarith.o \
@@ -404,7 +404,7 @@ this_lib_flags := -ltheora
 include $(ROOT_PATH)/sharedlib_test.mk
 ifneq ($(this_lib_available), yes)
 INCLUDES += -I$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/theora/include
-OBJS_DEPS += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/theora/lib/bitpack.o \
+OBJS_DEPS_THEORA += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/theora/lib/bitpack.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/theora/lib/decinfo.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/theora/lib/decode.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/theora/lib/dequant.o \
@@ -435,7 +435,7 @@ include $(ROOT_PATH)/sharedlib_test.mk
 ifneq ($(this_lib_available), yes)
 DEFINES += -DFT2_BUILD_LIBRARY
 INCLUDES += -I$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/freetype/include
-OBJS_DEPS += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/freetype/src/autofit/afangles.o \
+OBJS_DEPS_FREETYPE += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/freetype/src/autofit/afangles.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/freetype/src/autofit/afblue.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/freetype/src/autofit/afcjk.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/freetype/src/autofit/afdummy.o \
@@ -559,7 +559,7 @@ this_lib_flags := -lfribidi
 include $(ROOT_PATH)/sharedlib_test.mk
 ifneq ($(this_lib_available), yes)
 INCLUDES += -I$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps) -I$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/fribidi
-OBJS_DEPS += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/fribidi/fribidi-arabic.o \
+OBJS_DEPS_FRIBIDI += $(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/fribidi/fribidi-arabic.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/fribidi/fribidi-bidi-types.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/fribidi/fribidi-bidi.o \
 	$(DEPS_PATH)/$(DEPS_FOLDER_libretro-deps)/fribidi/fribidi-brackets.o \
-- 
2.34.1

